<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Control remoto (simple)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; text-align:center; margin:40px; background:#f6f7fb; }
    .card { display:inline-block; padding:20px 28px; background:#fff; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    h1 { margin:0 0 14px 0; font-size:20px; color:#222; }
    select, button { font-size:16px; padding:10px; margin:8px; border-radius:8px; }
    select { min-width:160px; }
    .activar { background:#2e8b57; color:#fff; border:none; }
    .desactivar { background:#c0392b; color:#fff; border:none; }
    .small { font-size:13px; color:#666; margin-top:6px; }
    #msg { margin-top:14px; font-weight:600; color:#111; min-height:24px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>üåê Panel simple ‚Äî Control del m√≥dem</h1>

    <div>
      <label for="device"><strong>Selecciona dispositivo</strong></label><br/>
      <select id="device">
        <option value="1">Dispositivo 1</option>
        <option value="2">Dispositivo 2</option>
        <option value="3">Dispositivo 3</option>
        <!-- Agrega m√°s opciones si las necesitas -->
      </select>
    </div>

    <div style="margin-top:12px;">
      <button class="activar" onclick="sendCmd('a')">üü¢ Activar</button>
      <button class="desactivar" onclick="sendCmd('d')">üî¥ Desactivar</button>
    </div>

    <div class="small">Registra el token solo en el dispositivo autorizado (opci√≥n abajo).</div>

    <div style="margin-top:16px;">
      <button onclick="registerToken()">üîê Registrar token</button>
      <button onclick="checkStatus()">‚ÑπÔ∏è Ver estado</button>
    </div>

    <div id="msg"></div>
  </div>

<script>
  // === CONFIGURA AQUI tu URL p√∫blica (ngrok) ===
  const SERVER = "https://unrehabilitatingly-aileen.ngrok-free.dev"; // reemplaza por tu URL real

  function show(text, ok=true){
    const el = document.getElementById('msg');
    el.textContent = text;
    el.style.color = ok ? '#0b5136' : '#9b1f1f';
  }

  function registerToken(){
    const tk = prompt("Pega aqu√≠ el token seguro (solo en tu dispositivo autorizado):");
    if(tk && tk.length>8){
      localStorage.setItem("RC_TOKEN", tk);
      show("‚úÖ Token guardado localmente.", true);
    } else {
      show("‚ö†Ô∏è Token inv√°lido.", false);
    }
  }

  async function sendCmd(type){
    const tk = localStorage.getItem("RC_TOKEN");
    if(!tk){
      show("‚ö†Ô∏è Token no configurado. Usa 'Registrar token' en tu dispositivo.", false);
      return;
    }
    const device = document.getElementById("device").value;
    const cmd = `${type} ${device}`; // sin tiempo
    show("‚è≥ Enviando comando...");
    try {
      const resp = await fetch(SERVER + "/mensaje", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ texto: cmd, token: tk })
      });
      if(!resp.ok){
        const j = await resp.json().catch(()=>({msg: resp.statusText}));
        show("‚ùå " + (j.msg || resp.statusText), false);
        return;
      }
      const j = await resp.json().catch(()=>null);
      show("‚úÖ " + (j && j.msg ? j.msg : "Comando enviado correctamente."));
    } catch (e){
      console.error(e);
      show("‚ùå Error de conexi√≥n. Verifica ngrok/servidor.", false);
    }
  }

  async function checkStatus(){
    try {
      const resp = await fetch(SERVER + "/status");
      if(!resp.ok){
        show("‚ùå No se pudo obtener estado.", false);
        return;
      }
      const st = await resp.json().catch(()=>null);
      if(st && st.mode){
        if(st.mode === "blocked" && st.remaining !== undefined){
          const rem = st.remaining;
          // formatear hh:mm:ss
          const h = Math.floor(rem/3600).toString().padStart(2,'0');
          const m = Math.floor((rem%3600)/60).toString().padStart(2,'0');
          const s = Math.floor(rem%60).toString().padStart(2,'0');
          show(`Estado: BLOQUEADO ‚Äî tiempo restante ${h}:${m}:${s}`);
        } else if(st.mode === "active"){
          show("Estado: ACTIVO");
        } else {
          show("Estado: " + JSON.stringify(st));
        }
      } else {
        const txt = await resp.text();
        show("Estado: " + txt);
      }
    } catch (e){
      console.error(e);
      show("‚ùå Error consultando estado.", false);
    }
  }

  // opcional: chequear estado al cargar
  window.addEventListener('load', checkStatus);
</script>
</body>
</html>
