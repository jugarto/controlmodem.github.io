<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control remoto</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 60px; background:#f9f9f9; }
    button { font-size: 18px; padding: 10px 20px; margin: 10px; border-radius: 8px; border:none; cursor:pointer; }
    .activar { background-color:#4CAF50; color:white; }
    .desactivar { background-color:#d9534f; color:white; }
    input, select { padding:6px; font-size:15px; border-radius:5px; border:1px solid #ccc; margin:5px; }
    #resultado { margin-top:20px; font-weight:bold; color:#333; }
    #contador { font-size:24px; color:#ff5555; margin-top:15px; }
  </style>
</head>
<body>

  <h1>üåê Control remoto del m√≥dem</h1>

  <p><b>Selecciona el dispositivo:</b></p>
  <select id="device">
    <option value="1">Dispositivo 1</option>
    <option value="2">Dispositivo 2</option>
    <option value="3">Dispositivo 3</option>
  </select>

  <div id="timeInputs" style="display:none;">
    <p><b>Duraci√≥n del bloqueo:</b></p>
    <input type="number" id="hours" placeholder="Horas" min="0" style="width:80px;">
    <input type="number" id="minutes" placeholder="Minutos" min="0" max="59" style="width:80px;">
    <input type="number" id="seconds" placeholder="Segundos" min="0" max="59" style="width:80px;">
  </div>

  <div style="margin-top:15px;">
    <button class="activar" onclick="enviar('a')">üü¢ Activar</button>
    <button class="desactivar" onclick="mostrarTiempo()">üî¥ Desactivar</button>
  </div>

  <p id="resultado"></p>
  <p id="contador"></p>

  <button style="margin-top:20px;" onclick="registrarToken()">Registrar token</button>

  <script>
    const SERVER = "https://unrehabilitated-divaricatingly-aileen.ngrok-free.dev"; // tu ngrok actual
    let countdownInterval = null;

    function registrarToken(){
      const tk = prompt("Introduce tu token seguro:");
      if (tk && tk.length > 10){
        localStorage.setItem("RC_TOKEN", tk);
        alert("‚úÖ Token guardado.");
      } else alert("‚ùå Token inv√°lido.");
    }

    function mostrarTiempo(){
      document.getElementById("timeInputs").style.display = "block";
      if (confirm("¬øDeseas enviar el comando de desactivaci√≥n ahora?")) enviar("d");
    }

    async function enviar(tipo){
      const tk = localStorage.getItem("RC_TOKEN");
      if (!tk) { alert("‚ö†Ô∏è Token no configurado."); return; }
      const device = document.getElementById("device").value;
      let comando = tipo + " " + device;

      if (tipo === "d"){
        const h = document.getElementById("hours").value || 0;
        const m = document.getElementById("minutes").value || 0;
        const s = document.getElementById("seconds").value || 0;
        comando += ` ${h}:${m}:${s}`;
      }

      const resultado = document.getElementById("resultado");
      resultado.textContent = "‚è≥ Enviando...";

      try {
        const r = await fetch(SERVER + "/mensaje", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ texto: comando, token: tk })
        });
        const j = await r.json();
        resultado.textContent = "‚úÖ " + j.msg;
        actualizarEstado();
      } catch(e){
        resultado.textContent = "‚ùå Error al conectar con el servidor.";
      }
    }

    async function actualizarEstado(){
      try {
        const r = await fetch(SERVER + "/status");
        const st = await r.json();
        const cont = document.getElementById("contador");
        if (st.mode === "blocked" && st.remaining > 0){
          iniciarTemporizador(st.remaining);
          cont.textContent = `Bloqueado ‚è≥ ${formato(st.remaining)}`;
        } else if (st.mode === "active"){
          detenerTemporizador();
          cont.textContent = "‚úÖ Dispositivo activo";
        } else {
          detenerTemporizador();
          cont.textContent = "";
        }
      } catch(e){
        console.log("No se pudo obtener estado");
      }
    }

    function formato(seg){
      const h = Math.floor(seg/3600);
      const m = Math.floor((seg%3600)/60);
      const s = seg%60;
      return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
    }

    function iniciarTemporizador(seg){
      detenerTemporizador();
      const cont = document.getElementById("contador");
      countdownInterval = setInterval(()=>{
        seg--;
        if (seg<=0){
          clearInterval(countdownInterval);
          cont.textContent = "‚úÖ Dispositivo reactivado";
          actualizarEstado();
        } else {
          cont.textContent = `Bloqueado ‚è≥ ${formato(seg)}`;
        }
      },1000);
    }

    function detenerTemporizador(){
      if (countdownInterval) clearInterval(countdownInterval);
      countdownInterval = null;
    }

    // Consulta cada 10s para sincronizar estado si cambi√≥ manualmente
    setInterval(actualizarEstado, 10000);
    actualizarEstado();
  </script>
</body>
</html>
