<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control remoto del m√≥dem</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 60px; background: #f8f9fa; }
    .card { display: inline-block; padding: 20px 30px; background: white; border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    button { font-size: 18px; padding: 10px 22px; margin: 10px; border-radius: 8px;
             border: none; cursor: pointer; transition: 0.2s ease; }
    .activar { background-color: #4CAF50; color: white; }
    .desactivar { background-color: #d9534f; color: white; }
    .activar:hover { background-color: #45a049; }
    .desactivar:hover { background-color: #c9302c; }
    input, select { padding: 8px; font-size: 15px; border-radius: 6px; border: 1px solid #ccc;
                    margin: 5px; width: 90px; text-align: center; }
    #contador { font-size: 26px; color: #ff5555; margin-top: 15px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>üåê Control remoto del m√≥dem</h1>

    <p><b>Selecciona el dispositivo:</b></p>
    <select id="device">
      <option value="1">Dispositivo 1</option>
      <option value="2">Dispositivo 2</option>
      <option value="3">Dispositivo 3</option>
    </select>

    <p><b>Duraci√≥n del bloqueo:</b></p>
    <div>
      <input type="number" id="hours" placeholder="Horas" min="0">
      <input type="number" id="minutes" placeholder="Minutos" min="0" max="59">
      <input type="number" id="seconds" placeholder="Segundos" min="0" max="59">
    </div>

    <div style="margin-top:15px;">
      <button class="activar" onclick="enviar('a')">üü¢ Activar</button>
      <button class="desactivar" onclick="enviar('d')">üî¥ Desactivar</button>
    </div>

    <p id="resultado"></p>
    <p id="contador"></p>

    <button style="margin-top:20px;" onclick="registrarToken()">Registrar token</button>
  </div>

  <script>
    const SERVER = "https://unrehabilitated-divaricatingly-aileen.ngrok-free.dev"; // tu URL de ngrok
    let countdownInterval = null;

    function registrarToken() {
      const tk = prompt("Introduce tu token seguro:");
      if (tk && tk.length > 10) {
        localStorage.setItem("RC_TOKEN", tk);
        alert("‚úÖ Token guardado.");
      } else alert("‚ùå Token inv√°lido.");
    }

    async function enviar(tipo) {
      const tk = localStorage.getItem("RC_TOKEN");
      if (!tk) { alert("‚ö†Ô∏è Token no configurado."); return; }

      const device = document.getElementById("device").value;
      let comando = tipo + " " + device;

      const h = parseInt(document.getElementById("hours").value) || 0;
      const m = parseInt(document.getElementById("minutes").value) || 0;
      const s = parseInt(document.getElementById("seconds").value) || 0;

      if (tipo === "d" && (h + m + s) === 0) {
        alert("‚ö†Ô∏è Debes ingresar una duraci√≥n antes de desactivar.");
        return;
      }

      if (tipo === "d") comando += ` ${h}:${m}:${s}`;

      document.getElementById("resultado").textContent = "‚è≥ Enviando...";
      try {
        const r = await fetch(SERVER + "/mensaje", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ texto: comando, token: tk })
        });
        const j = await r.json();
        document.getElementById("resultado").textContent = "‚úÖ " + j.msg;
        actualizarEstado();
      } catch (e) {
        document.getElementById("resultado").textContent = "‚ùå Error al conectar.";
      }
    }

    async function actualizarEstado() {
      try {
        const r = await fetch(SERVER + "/status");
        const st = await r.json();
        const cont = document.getElementById("contador");

        if (st.mode === "blocked" && st.remaining > 0) {
          iniciarTemporizador(st.remaining);
        } else if (st.mode === "active") {
          detenerTemporizador();
          cont.textContent = "‚úÖ Dispositivo activo";
        } else {
          cont.textContent = "";
        }
      } catch (e) {
        console.log("Error al actualizar estado:", e);
      }
    }

    function formato(seg) {
      const h = Math.floor(seg / 3600);
      const m = Math.floor((seg % 3600) / 60);
      const s = seg % 60;
      return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
    }

    function iniciarTemporizador(seg) {
      detenerTemporizador();
      const cont = document.getElementById("contador");
      countdownInterval = setInterval(() => {
        if (seg <= 0) {
          clearInterval(countdownInterval);
          cont.textContent = "‚úÖ Dispositivo reactivado";
          actualizarEstado();
        } else {
          cont.textContent = `Bloqueado ‚è≥ ${formato(seg)}`;
          seg--;
        }
      }, 1000);
    }

    function detenerTemporizador() {
      if (countdownInterval) clearInterval(countdownInterval);
      countdownInterval = null;
    }

    setInterval(actualizarEstado, 3000);
    actualizarEstado();
  </script>
</body>
</html>
